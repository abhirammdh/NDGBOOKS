// Enhanced book data with comprehensive information
const booksData = {
  1: [
    {
      title: "Higher Engineering Mathematics",
      subject: "maths",
      image: "https://i.ibb.co/jvHfDZWW/higher-calculus.png",
      downloadLink: "https://drive.google.com/file/d/1Pzf81yV9QS_stZck8KquDS_xfEic-Y55/view?usp=sharing",
      author: "B.S. Grewal",
      pages: "1456",
    },
    {
      title: "How to Solve it by Computer",
      subject: "computer-science",
      image: "https://i.ibb.co/HTGT1CNB/pascal.png",
      downloadLink: "https://drive.google.com/file/d/1A3J8R5inOwnaPMOLlLZ3COJA3jWUcLAZ/view?usp=sharing",
      author: "R.G. Dromey",
      pages: "432",
    },
    {
      title: "Sathyam Sivam Sundaram Volume-1",
      subject: "awareness",
      image: "https://i.ibb.co/JW4QXwhY/sss.png",
      downloadLink: "https://drive.google.com/file/d/15Mfa7lE1J8L6v1bdeiS0RJSDMGP-wb1i/view?usp=sharing",
      author: "Sri Sathya Sai Baba",
      pages: "324",
    },
    {
      title: "Software Lab in Python â€“ I",
      subject: "lab",
      image: "https://i.ibb.co/Jwt2mwWg/learn.png",
      downloadLink: "https://drive.google.com/file/d/1sKAxbZ75-jF8viKAjxE9g2aRaviIUnJ9/view?usp=sharing",
      author: "University Press",
      pages: "256",
    },
    {
      title: "Tuesdays with Morrie",
      subject: "eng",
      image: "https://i.ibb.co/qL6fC0M4/tues.png",
      downloadLink: "https://drive.google.com/file/d/1HUvFKdqN8hLHfe-QmEeI5G3wlRSe_Bo3/view?usp=sharing",
      author: "Mitch Albom",
      pages: "192",
    },
    {
      title: "English Text Book",
      subject: "eng",
      image: "https://i.ibb.co/0pyCGVCp/englishtextbook.png",
      downloadLink: "https://drive.google.com/file/d/1_GobWZZ_xIrbgWWvyURsCpQMKIvJuTb4/view?usp=sharing",
      author: "Academic Publishers",
      pages: "384",
    },
  ],
  2: [
    {
      title: "Applied Statistics and Probability",
      subject: "maths",
      image: "https://i.ibb.co/RkdHtgGL/prob.png",
      downloadLink: "https://drive.google.com/file/d/1qhEvaE_UiVHMVdZoxTh4ywX8rrzShvjv/view?usp=sharing",
      author: "Montgomery & Runger",
      pages: "768",
    },
    {
      title: "Data Structures and Algorithms",
      subject: "computer-science",
      image: "https://i.ibb.co/8DMjFg94/dsc.png",
      downloadLink: "https://drive.google.com/file/d/1qhhYY9Rq4zB6Lb3g7ZU-k1yOzS0oMSt0/view?usp=sharing",
      author: "Cormen, Leiserson, Rivest",
      pages: "1312",
    },
    {
      title: "Vidya Vahini",
      subject: "awareness",
      image:"https://i.ibb.co/0RSYMnF2/51l0y-G6-Ic-IL-jpg-BO30-255-255-255-UF900-850-SR1910-1000-0-C-PIRIOFIVE-medium-Bottom-Left-30-20-ZA6.jpg",
      downloadLink: "https://drive.google.com/file/d/1MzUaL_RTJGzat9QKdDyFgFt2sRqCOPuX/view?usp=sharing",
      author: "Sri Sathya Sai Baba",
      pages: "298",
    },
    {
      title: "Software Lab in Python-II",
      subject: "lab",
      image: "https://i.ibb.co/bR6d1221/think.png",
      downloadLink: "https://drive.google.com/file/d/1iVfU0eQnhlBTlchwIOndhaSrolMFCtVK/view?usp=sharing",
      author: "University Press",
      pages: "312",
    },
  ],
  3: [
    {
      title: "Discrete Mathematics for Computer Science",
      subject: "maths",
      image: "https://i.ibb.co/TVnjvqn/dis.png",
      downloadLink: "https://drive.google.com/file/d/your-file-id-9/view",
      author: "Kenneth Rosen",
      pages: "896",
    },
    {
      title: "Computer Organization and Design",
      subject: "computer-science",
      image: "https://i.ibb.co/dw9dk6Hx/nova.png",
      downloadLink: "https://drive.google.com/file/d/1WDc7KkUu8hVCVG41IhrQlY3yGteTGgrS/view?usp=sharing",
      author: "Patterson & Hennessy",
      pages: "704",
    },
    {
      title: "Statistics for Data Science",
      subject: "maths",
      image: "https://i.ibb.co/RkdHtgGL/prob.png",
      downloadLink: "https://drive.google.com/file/d/1qhEvaE_UiVHMVdZoxTh4ywX8rrzShvjv/view?usp=sharing",
      author: "James, Witten, Hastie",
      pages: "426",
    },
    {
      title: "Software Lab in Data Visualization",
      subject: "lab",
      image: "https://i.ibb.co/yHMrftr/vis.png",
      downloadLink: "https://drive.google.com/file/d/1nN3BgI5zGUdH__ui6GMxFZ3Mlk44z75H/view?usp=sharing",
      author: "University Press",
      pages: "284",
    },
    {
      title: "Ramakatha Rasavahini",
      subject: "awareness",
      image: "https://i.ibb.co/93ZnC6WD/51-WK-GVt-M5-L-jpg-BO30-255-255-255-UF900-850-SR1910-1000-0-C-QL100.jpg",
      downloadLink: "https://drive.google.com/file/d/11tjU_KelxAe2CQEjgWv3YV1BeX9kx_Yi/view?usp=sharing",
      author: "Sri Sathya Sai Baba",
      pages: "356",
    },
  ],
  4: [
    {
      title: "Linear Algebra for Data Science",
      subject: "maths",
      image: "https://i.ibb.co/xWBBMgz/la.png",
      downloadLink: "https://drive.google.com/file/d/1mEmyFRY2vkO4lU8nACMhCVZxFEA78MRR/view?usp=sharing",
      author: "Gilbert Strang",
      pages: "574",
    },
    {
      title: "Database Management Systems",
      subject: "computer-science",
      image: "https://i.ibb.co/35pV9Zsw/image.png",
      downloadLink: "https://drive.google.com/file/d/1hZDw9LlhNj4UFGwJOY_VeJs49ZI7Sk6q/view?usp=sharing",
      author: "Ramez Elmasri",
      pages: "1272",
    },
    {
      title: "Object Oriented Programming Concepts",
      subject: "computer-science",
      image: "https://i.ibb.co/xKnRbkp4/co.png",
      downloadLink: "https://drive.google.com/file/d/your-file-id-15/view",
      author: "Herbert Schildt",
      pages: "688",
    },
    {
      title: "Software Lab in SQL",
      subject: "lab",
      image: "/placeholder.svg?height=280&width=350&text=SQL+Laboratory",
      downloadLink: "https://drive.google.com/file/d/your-file-id-16/view",
      author: "University Press",
      pages: "298",
    },
    {
      title: "Bhagavathi Vahini",
      subject: "awareness",
      image: "/placeholder.svg?height=280&width=350&text=Bhagavathi+Vahini",
      downloadLink: "https://drive.google.com/file/d/your-file-id-12/view",
      author: "Sri Sathya Sai Baba",
      pages: "412",
    },
  ],
  5: [
    {
      title: "Optimization for Machine Learning",
      subject: "maths",
      image: "/placeholder.svg?height=280&width=350&text=ML+Optimization",
      downloadLink: "https://drive.google.com/file/d/your-file-id-17/view",
      author: "Stephen Boyd",
      pages: "716",
    },
    {
      title: "Operating Systems",
      subject: "computer-science",
      image: "/placeholder.svg?height=280&width=350&text=Operating+Systems",
      downloadLink: "https://drive.google.com/file/d/your-file-id-18/view",
      author: "Abraham Silberschatz",
      pages: "944",
    },
    {
      title: "Computer Networks",
      subject: "computer-science",
      image: "/placeholder.svg?height=280&width=350&text=Computer+Networks",
      downloadLink: "https://drive.google.com/file/d/your-file-id-18/view",
      author: "Andrew Tanenbaum",
      pages: "960",
    },
    {
      title: "Data Mining and Machine Learning",
      subject: "computer-science",
      image: "/placeholder.svg?height=280&width=350&text=Data+Mining+ML",
      downloadLink: "https://drive.google.com/file/d/your-file-id-18/view",
      author: "Ian Witten",
      pages: "664",
    },
    {
      title: "Dharma Vahini",
      subject: "awareness",
      image: "/placeholder.svg?height=280&width=350&text=Dharma+Vahini",
      downloadLink: "https://drive.google.com/file/d/your-file-id-19/view",
      author: "Sri Sathya Sai Baba",
      pages: "368",
    },
    {
      title: "Software Lab in Java",
      subject: "lab",
      image: "/placeholder.svg?height=280&width=350&text=Java+Laboratory",
      downloadLink: "https://drive.google.com/file/d/your-file-id-20/view",
      author: "University Press",
      pages: "456",
    },
  ],
  6: [
    {
      title: "Operations Research",
      subject: "maths",
      image: "/placeholder.svg?height=280&width=350&text=Operations+Research",
      downloadLink: "https://drive.google.com/file/d/your-file-id-21/view",
      author: "Hamdy Taha",
      pages: "848",
    },
    {
      title: "Design and Analysis of Algorithms",
      subject: "computer-science",
      image: "/placeholder.svg?height=280&width=350&text=Algorithm+Design+Analysis",
      downloadLink: "https://drive.google.com/file/d/your-file-id-22/view",
      author: "Jon Kleinberg",
      pages: "864",
    },
    {
      title: "Big Data Analytics",
      subject: "computer-science",
      image: "/placeholder.svg?height=280&width=350&text=Big+Data+Analytics",
      downloadLink: "https://drive.google.com/file/d/your-file-id-23/view",
      author: "Michael Minelli",
      pages: "528",
    },
    {
      title: "Software Lab in Web Programming",
      subject: "lab",
      image: "/placeholder.svg?height=280&width=350&text=Web+Programming+Lab",
      downloadLink: "https://drive.google.com/file/d/your-file-id-24/view",
      author: "University Press",
      pages: "384",
    },
  ],
  7: [
    {
      title: "Linux System Programming",
      subject: "computer-science",
      image: "/placeholder.svg?height=280&width=350&text=Linux+System+Programming",
      downloadLink: "https://drive.google.com/file/d/your-file-id-26/view",
      author: "Robert Love",
      pages: "456",
    },
    {
      title: "Cloud Computing",
      subject: "computer-science",
      image: "/placeholder.svg?height=280&width=350&text=Cloud+Computing",
      downloadLink: "https://drive.google.com/file/d/your-file-id-27/view",
      author: "Thomas Erl",
      pages: "528",
    },
  ],
  8: [
    {
      title: "Formal Languages and Automata Theory",
      subject: "computer-science",
      image: "/placeholder.svg?height=280&width=350&text=Formal+Languages+Automata",
      downloadLink: "https://drive.google.com/file/d/your-file-id-30/view",
      author: "John Hopcroft",
      pages: "744",
    },
  ],
  9: [
    {
      title: "Advanced Research Methodology",
      subject: "awareness",
      image: "/placeholder.svg?height=280&width=350&text=Research+Methodology",
      downloadLink: "https://drive.google.com/file/d/your-file-id-31/view",
      author: "C.R. Kothari",
      pages: "418",
    },
  ],
}

// Application state management
let currentBook = null
let currentPage = 1
const totalPages = 100
const studyNotes = JSON.parse(localStorage.getItem("studyNotes")) || {}
const readerPreferences = JSON.parse(localStorage.getItem("readerPreferences")) || {
  theme: "light",
  fontSize: "16",
  lineSpacing: "1.5",
}

// DOM elements
const searchInput = document.getElementById("searchInput")
const searchButton = document.getElementById("searchBtn")
const filterButtons = document.querySelectorAll(".filter-button")
const suggestionTags = document.querySelectorAll(".suggestion-tag")
const mobileMenuToggle = document.querySelector(".mobile-menu-toggle")
const mainNavigation = document.querySelector(".main-navigation")

// Initialize application
document.addEventListener("DOMContentLoaded", () => {
  initializeApplication()
  setupEventListeners()
  setupReaderEventListeners()
  loadAllBooks()
  updateBookCounts()
  setupIntersectionObservers()
})

// Initialize application
function initializeApplication() {
  // Apply saved reader preferences
  applyReaderPreferences()
}

// Setup intersection observers for animations
function setupIntersectionObservers() {
  // Observer for semester sections
  const semesterObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add("visible")
        }
      })
    },
    { threshold: 0.1 },
  )

  // Observer for book items
  const bookObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          // Add a staggered delay based on the index
          const index = Array.from(entry.target.parentNode.children).indexOf(entry.target)
          setTimeout(() => {
            entry.target.classList.add("visible")
          }, index * 100) // 100ms delay between each item
        }
      })
    },
    { threshold: 0.1 },
  )

  // Observer for features
  const featureObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const index = Array.from(entry.target.parentNode.children).indexOf(entry.target)
          setTimeout(() => {
            entry.target.classList.add("visible")
          }, index * 200) // 200ms delay between each feature
        }
      })
    },
    { threshold: 0.1 },
  )

  // Observe elements
  document.querySelectorAll(".semester-section").forEach((section) => {
    semesterObserver.observe(section)
  })

  document.querySelectorAll(".book-item").forEach((book) => {
    bookObserver.observe(book)
  })

  document.querySelectorAll(".feature").forEach((feature) => {
    featureObserver.observe(feature)
  })
}

// Setup event listeners
function setupEventListeners() {
  // Search functionality
  searchButton.addEventListener("click", performSearch)
  searchInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      performSearch()
    }
  })

  // Search suggestions
  suggestionTags.forEach((tag) => {
    tag.addEventListener("click", () => {
      searchInput.value = tag.dataset.search
      performSearch()
    })
  })

  // Filter functionality
  filterButtons.forEach((button) => {
    button.addEventListener("click", () => {
      filterButtons.forEach((btn) => btn.classList.remove("active"))
      button.classList.add("active")
      const filter = button.getAttribute("data-filter")
      filterBooks(filter)
    })
  })

  // Mobile menu toggle
  mobileMenuToggle.addEventListener("click", () => {
    mainNavigation.classList.toggle("active")
    mobileMenuToggle.classList.toggle("active")
  })

  // Smooth scrolling for navigation links
  document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
    anchor.addEventListener("click", function (e) {
      e.preventDefault()
      const target = document.querySelector(this.getAttribute("href"))
      if (target) {
        target.scrollIntoView({
          behavior: "smooth",
          block: "start",
        })
      }
    })
  })
}

// Load all books into their respective semesters
function loadAllBooks() {
  for (let semester = 1; semester <= 9; semester++) {
    const container = document.getElementById(`books-semester-${semester}`)
    if (container && booksData[semester]) {
      container.innerHTML = ""
      booksData[semester].forEach((book) => {
        const bookElement = createBookElement(book)
        container.appendChild(bookElement)
      })
    }
  }
}

// Create book element
function createBookElement(book) {
  const bookItem = document.createElement("div")
  bookItem.className = `book-item ${book.subject}`

  bookItem.innerHTML = `
    <div class="book-image-container">
      <img src="${book.image}" alt="${book.title}" class="book-image" loading="lazy">
      <div class="book-subject-badge">${getSubjectDisplayName(book.subject)}</div>
    </div>
    <div class="book-details">
      <h3 class="book-title">${book.title}</h3>
      <div class="book-meta">
        <span class="book-author">${book.author}</span>
        <span class="book-pages">${book.pages} pages</span>
      </div>
      <div class="book-actions">
        <button class="action-button read-button" onclick="openDigitalReader('${book.title}', '${book.downloadLink}', '${book.subject}', '${book.author}')">
          Read Online
        </button>
        <a href="${book.downloadLink}" target="_blank" class="action-button download-button">
          Download PDF
        </a>
      </div>
    </div>
  `

  return bookItem
}

// Get subject display name
function getSubjectDisplayName(subject) {
  const subjectNames = {
    maths: "Mathematics",
    "computer-science": "Computer Science",
    awareness: "General Studies",
    lab: "Laboratory",
    html: "Web Technologies",
    js: "Programming",
    css: "Design",
    eng: "English Literature",
  }
  return subjectNames[subject] || subject
}

// Update book counts for each semester
function updateBookCounts() {
  for (let semester = 1; semester <= 9; semester++) {
    const countElement = document.getElementById(`count-semester-${semester}`)
    if (countElement && booksData[semester]) {
      const count = booksData[semester].length
      countElement.textContent = `${count} Resource${count !== 1 ? "s" : ""}`
    }
  }
}

// Search functionality
function performSearch() {
  const searchTerm = searchInput.value.toLowerCase().trim()
  if (!searchTerm) {
    showAllBooks()
    return
  }

  const allBooks = document.querySelectorAll(".book-item")
  let hasResults = false

  allBooks.forEach((book) => {
    const title = book.querySelector(".book-title").textContent.toLowerCase()
    const author = book.querySelector(".book-author").textContent.toLowerCase()
    const subject = book.querySelector(".book-subject-badge").textContent.toLowerCase()

    if (title.includes(searchTerm) || author.includes(searchTerm) || subject.includes(searchTerm)) {
      book.style.display = "block"
      hasResults = true
    } else {
      book.style.display = "none"
    }
  })

  // Show/hide semester sections
  document.querySelectorAll(".semester-section").forEach((section) => {
    const visibleBooks = section.querySelectorAll('.book-item[style*="block"], .book-item:not([style*="none"])')
    section.style.display = visibleBooks.length === 0 ? "none" : "block"
  })

  if (!hasResults) {
    showNoResults()
  }
}

// Filter books by subject
function filterBooks(filter) {
  const allBooks = document.querySelectorAll(".book-item")

  allBooks.forEach((book) => {
    if (filter === "all" || book.classList.contains(filter)) {
      book.style.display = "block"
    } else {
      book.style.display = "none"
    }
  })

  // Show/hide semester sections
  document.querySelectorAll(".semester-section").forEach((section) => {
    const visibleBooks = section.querySelectorAll('.book-item[style*="block"], .book-item:not([style*="none"])')
    section.style.display = visibleBooks.length === 0 ? "none" : "block"
  })
}

// Show all books
function showAllBooks() {
  document.querySelectorAll(".book-item").forEach((book) => {
    book.style.display = "block"
  })
  document.querySelectorAll(".semester-section").forEach((section) => {
    section.style.display = "block"
  })

  // Remove no results message
  const existingMessage = document.querySelector(".no-results")
  if (existingMessage) {
    existingMessage.remove()
  }
}

// Show no results message
function showNoResults() {
  const existingMessage = document.querySelector(".no-results")
  if (existingMessage) {
    existingMessage.remove()
  }

  const noResultsDiv = document.createElement("div")
  noResultsDiv.className = "no-results"
  noResultsDiv.innerHTML = `
    <h3>No academic resources found</h3>
    <p>Try searching with different keywords or browse by academic discipline.</p>
  `

  document.querySelector(".main-content .container").appendChild(noResultsDiv)
}

// Digital reader functionality
function openDigitalReader(title, downloadLink, subject, author) {
  currentBook = { title, downloadLink, subject, author }
  currentPage = 1

  const reader = document.getElementById("digitalReader")
  const readerTitle = document.getElementById("readerBookTitle")
  const readerSubject = document.getElementById("readerSubject")
  const bookViewer = document.getElementById("bookViewer")

  readerTitle.textContent = title
  readerSubject.textContent = getSubjectDisplayName(subject)

  // Convert Google Drive link to embeddable format
  const fileId = extractFileId(downloadLink)
  if (fileId) {
    bookViewer.src = `https://drive.google.com/file/d/${fileId}/preview`
  }

  reader.style.display = "block"
  document.body.style.overflow = "hidden"

  // Apply saved preferences
  applyReaderPreferences()
  updatePageInfo()
  loadStudyNotes(title, currentPage)
  updateReadingProgress()
}

// Setup reader event listeners
function setupReaderEventListeners() {
  // Reader controls
  document.getElementById("closeReaderBtn").addEventListener("click", closeDigitalReader)
  document.getElementById("settingsBtn").addEventListener("click", openSettingsPanel)
  document.getElementById("fullscreenBtn").addEventListener("click", toggleFullscreen)

  // Page navigation
  document.getElementById("prevPageBtn").addEventListener("click", previousPage)
  document.getElementById("nextPageBtn").addEventListener("click", nextPage)

  // Study notes
  document.getElementById("addNoteBtn").addEventListener("click", addStudyNote)

  // Settings panel
  document.getElementById("closeSettingsBtn").addEventListener("click", closeSettingsPanel)

  // Page selector
  document.getElementById("pageNumberInput").addEventListener("change", (e) => {
    const newPage = Number.parseInt(e.target.value)
    if (newPage >= 1 && newPage <= totalPages) {
      currentPage = newPage
      updatePageInfo()
      loadStudyNotes(currentBook.title, currentPage)
      updateReadingProgress()
    }
  })

  // Keyboard shortcuts
  document.addEventListener("keydown", (e) => {
    if (document.getElementById("digitalReader").style.display === "block") {
      switch (e.key) {
        case "ArrowLeft":
          e.preventDefault()
          previousPage()
          break
        case "ArrowRight":
          e.preventDefault()
          nextPage()
          break
        case "f":
        case "F":
          if (e.ctrlKey) {
            e.preventDefault()
            toggleFullscreen()
          }
          break
        case "Escape":
          if (document.getElementById("settingsPanel").style.display === "block") {
            closeSettingsPanel()
          } else {
            closeDigitalReader()
          }
          break
      }
    }
  })

  // Theme options
  document.querySelectorAll(".theme-option").forEach((option) => {
    option.addEventListener("click", () => {
      document.querySelectorAll(".theme-option").forEach((opt) => opt.classList.remove("active"))
      option.classList.add("active")
      applyTheme(option.dataset.theme)
    })
  })

  // Font size control
  document.getElementById("fontSizeRange").addEventListener("input", (e) => {
    readerPreferences.fontSize = e.target.value
    applyReaderPreferences()
    saveReaderPreferences()
    document.getElementById("fontSizeDisplay").textContent = e.target.value + "px"
  })

  // Line spacing control
  document.getElementById("lineSpacingRange").addEventListener("input", (e) => {
    readerPreferences.lineSpacing = e.target.value
    applyReaderPreferences()
    saveReaderPreferences()
    document.getElementById("lineSpacingDisplay").textContent = e.target.value
  })

  // Note input enter key
  document.getElementById("noteTextarea").addEventListener("keypress", (e) => {
    if (e.key === "Enter" && e.ctrlKey) {
      addStudyNote()
    }
  })
}

// Page navigation functions
function nextPage() {
  if (currentPage < totalPages) {
    currentPage++
    updatePageInfo()
    loadStudyNotes(currentBook.title, currentPage)
    updateReadingProgress()
  }
}

function previousPage() {
  if (currentPage > 1) {
    currentPage--
    updatePageInfo()
    loadStudyNotes(currentBook.title, currentPage)
    updateReadingProgress()
  }
}

function updatePageInfo() {
  const pageIndicator = document.getElementById("pageIndicator")
  const prevBtn = document.getElementById("prevPageBtn")
  const nextBtn = document.getElementById("nextPageBtn")
  const pageInput = document.getElementById("pageNumberInput")

  pageIndicator.textContent = `Page ${currentPage} of ${totalPages}`
  prevBtn.disabled = currentPage === 1
  nextBtn.disabled = currentPage === totalPages
  pageInput.value = currentPage
  pageInput.max = totalPages
}

function updateReadingProgress() {
  const progressBar = document.querySelector(".progress-indicator")
  if (progressBar && totalPages > 0) {
    const progress = (currentPage / totalPages) * 100
    progressBar.style.width = progress + "%"
  }
}

// Extract file ID from Google Drive URL
function extractFileId(url) {
  const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/)
  return match ? match[1] : null
}

// Close digital reader
function closeDigitalReader() {
  const reader = document.getElementById("digitalReader")
  reader.style.display = "none"
  document.body.style.overflow = "auto"
  currentBook = null
}

// Study notes functionality
function loadStudyNotes(bookTitle, page) {
  const notesList = document.getElementById("notesList")
  const bookKey = `${bookTitle}_page_${page}`
  const notes = studyNotes[bookKey] || []

  notesList.innerHTML = ""

  if (notes.length === 0) {
    notesList.innerHTML = `
      <div style="text-align: center; color: #718096; padding: 2rem;">
        <p>No study notes for this page yet.</p>
        <p>Add your first note above!</p>
      </div>
    `
    return
  }

  notes.forEach((note, index) => {
    const noteDiv = document.createElement("div")
    noteDiv.className = "note-item"
    noteDiv.innerHTML = `
      <div class="note-meta">
        <span>Page ${page} â€¢ ${note.date}</span>
        <button class="delete-note" onclick="deleteStudyNote('${bookTitle}', ${page}, ${index})">Delete</button>
      </div>
      <div class="note-text">${note.text}</div>
    `
    notesList.appendChild(noteDiv)
  })
}

function addStudyNote() {
  const noteTextarea = document.getElementById("noteTextarea")
  const pageInput = document.getElementById("pageNumberInput")
  const noteText = noteTextarea.value.trim()
  const targetPage = Number.parseInt(pageInput.value) || currentPage

  if (!noteText || !currentBook) return

  const bookTitle = currentBook.title
  const bookKey = `${bookTitle}_page_${targetPage}`

  if (!studyNotes[bookKey]) {
    studyNotes[bookKey] = []
  }

  const newNote = {
    text: noteText,
    date: new Date().toLocaleString(),
    page: targetPage,
  }

  studyNotes[bookKey].push(newNote)
  localStorage.setItem("studyNotes", JSON.stringify(studyNotes))

  noteTextarea.value = ""

  if (targetPage === currentPage) {
    loadStudyNotes(bookTitle, currentPage)
  }

  showNotification(`Study note added to page ${targetPage}`)
}

function deleteStudyNote(bookTitle, page, index) {
  const bookKey = `${bookTitle}_page_${page}`
  if (studyNotes[bookKey]) {
    studyNotes[bookKey].splice(index, 1)
    if (studyNotes[bookKey].length === 0) {
      delete studyNotes[bookKey]
    }
    localStorage.setItem("studyNotes", JSON.stringify(studyNotes))
    loadStudyNotes(bookTitle, page)
    showNotification("Study note deleted successfully")
  }
}

// Settings panel functionality
function openSettingsPanel() {
  const settingsPanel = document.getElementById("settingsPanel")
  settingsPanel.style.display = "block"

  // Update current values
  document.getElementById("fontSizeRange").value = readerPreferences.fontSize
  document.getElementById("fontSizeDisplay").textContent = readerPreferences.fontSize + "px"
  document.getElementById("lineSpacingRange").value = readerPreferences.lineSpacing
  document.getElementById("lineSpacingDisplay").textContent = readerPreferences.lineSpacing

  // Highlight current theme
  document.querySelectorAll(".theme-option").forEach((option) => {
    option.classList.remove("active")
    if (option.dataset.theme === readerPreferences.theme) {
      option.classList.add("active")
    }
  })
}

function closeSettingsPanel() {
  const settingsPanel = document.getElementById("settingsPanel")
  settingsPanel.style.display = "none"
}

function applyTheme(theme) {
  readerPreferences.theme = theme
  applyReaderPreferences()
  saveReaderPreferences()
}

function applyReaderPreferences() {
  const readerInterface = document.querySelector(".reader-interface")

  if (readerInterface) {
    readerInterface.className = `reader-interface ${readerPreferences.theme}`
  }
}

function saveReaderPreferences() {
  localStorage.setItem("readerPreferences", JSON.stringify(readerPreferences))
}

// Fullscreen functionality
function toggleFullscreen() {
  const readerInterface = document.querySelector(".reader-interface")

  if (!document.fullscreenElement) {
    readerInterface.requestFullscreen().then(() => {
      readerInterface.classList.add("fullscreen")
    })
  } else {
    document.exitFullscreen().then(() => {
      readerInterface.classList.remove("fullscreen")
    })
  }
}

// Notification system
function showNotification(message) {
  // Remove any existing notifications
  const existingNotifications = document.querySelectorAll(".notification")
  existingNotifications.forEach((notification) => {
    notification.remove()
  })

  const notification = document.createElement("div")
  notification.className = "notification"
  notification.textContent = message

  document.body.appendChild(notification)

  setTimeout(() => {
    notification.style.animation = "slideOut 0.3s ease"
    setTimeout(() => notification.remove(), 300)
  }, 3000)
}

// Loading animation for download buttons
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("download-button")) {
    const originalText = e.target.textContent
    e.target.textContent = "Opening PDF..."

    setTimeout(() => {
      e.target.textContent = originalText
    }, 2000)
  }
})

// Scroll to top functionality
window.addEventListener("scroll", () => {
  const scrollButton = document.getElementById("scrollToTop")
  if (window.pageYOffset > 300) {
    if (!scrollButton) {
      createScrollToTopButton()
    }
  } else {
    if (scrollButton) {
      scrollButton.remove()
    }
  }
})

function createScrollToTopButton() {
  const button = document.createElement("button")
  button.id = "scrollToTop"
  button.textContent = "â†‘"
  button.style.cssText = `
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #2b6cb0;
    color: white;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(43, 108, 176, 0.3);
    z-index: 1000;
    transition: all 0.3s ease;
  `

  button.addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior: "smooth" })
  })

  button.addEventListener("mouseenter", () => {
    button.style.transform = "scale(1.1)"
    button.style.boxShadow = "0 6px 25px rgba(43, 108, 176, 0.4)"
  })

  button.addEventListener("mouseleave", () => {
    button.style.transform = "scale(1)"
    button.style.boxShadow = "0 4px 20px rgba(43, 108, 176, 0.3)"
  })

  document.body.appendChild(button)
}
